var Ne=Object.defineProperty;var we=(n,e,t)=>e in n?Ne(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var q=(n,e,t)=>we(n,typeof e!="symbol"?e+"":e,t);import{j as a,B as be,D as Pe,U as je,r as m,V as _e,W as Ee,X as Le,Y as ke,Z as Re,_ as He,$ as Ae,a0 as De,k as Fe,l as Oe,n as $e,a1 as Me,p as Ve,a2 as Ge,v as Ke,a3 as Ue,a4 as ze,a5 as Te,h as Ye,a6 as Q,m as Be,o as Xe,w as Je,a7 as Ze,a8 as qe,a9 as Qe,aa as We,y as et,z as tt,ab as st,ac as nt,I as at,ad as rt,ae as ot,af as it}from"./index-CgjISbDs.js";import{P as ct,T as lt,L as dt}from"./TeamResultComponent-D7azI_JI.js";function ut({competition:n,courseName:e,totalParticipants:t,variant:s="footer"}){const c=s==="header"?"bg-rough/30 rounded-xl p-4 border border-soft-grey":"bg-rough/30 border-t border-soft-grey px-4 py-2 flex-shrink-0";return a.jsx("div",{className:c,children:a.jsxs("div",{className:"flex items-center justify-center gap-4 md:gap-8 text-label-sm text-charcoal font-primary",children:[a.jsxs("div",{className:"flex items-center gap-1.5",children:[a.jsx(be,{className:"h-4 w-4 text-turf"}),a.jsx("span",{className:"hidden sm:inline",children:new Date(n.date).toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"})}),a.jsx("span",{className:"sm:hidden",children:new Date(n.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})})]}),a.jsxs("div",{className:"flex items-center gap-1.5",children:[a.jsx(Pe,{className:"h-4 w-4 text-turf"}),a.jsx("span",{className:"truncate",children:e||"Loading..."})]}),a.jsxs("div",{className:"flex items-center gap-1.5",children:[a.jsx(je,{className:"h-4 w-4 text-turf"}),a.jsxs("span",{children:[t," participants"]})]})]})})}function mt({isOpen:n,onClose:e,onSave:t,participant:s}){const[c,h]=m.useState("");m.useEffect(()=>{s&&h(s.currentName||"")},[s]);const y=()=>{if(!s)return;const l=c.trim();l.length!==0&&t(s.id,l)},x=()=>{h((s==null?void 0:s.currentName)||""),e()},v=l=>{l.key==="Enter"?(l.preventDefault(),y()):l.key==="Escape"&&(l.preventDefault(),x())};return s?a.jsx(_e,{open:n,onOpenChange:e,children:a.jsxs(Ee,{children:[a.jsx(Le,{className:"fixed inset-0 bg-black bg-opacity-50 z-50"}),a.jsx(ke,{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-scorecard rounded-xl p-6 w-full max-w-sm shadow-xl border border-soft-grey max-h-[90vh] overflow-y-auto",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx(Re,{className:"text-lg font-semibold text-fairway font-display",children:"Edit Player Name"}),a.jsx(He,{asChild:!0,children:a.jsx("button",{className:"p-2 hover:bg-flag hover:bg-opacity-10 rounded-xl transition-colors","aria-label":"Close",children:a.jsx(Ae,{className:"h-4 w-4 text-flag"})})})]}),a.jsx("div",{className:"mb-4",children:a.jsxs("p",{className:"text-sm text-turf font-primary",children:["Editing position:"," ",a.jsx("span",{className:"font-medium",children:s.positionName})]})}),a.jsxs("div",{className:"mb-6",children:[a.jsx("label",{htmlFor:"player-name",className:"block text-sm font-medium text-charcoal mb-2 font-primary",children:"Player Name"}),a.jsx("input",{id:"player-name",type:"text",value:c,onChange:l=>h(l.target.value),onKeyDown:v,className:"w-full p-3 border-2 border-soft-grey rounded-xl text-charcoal font-primary focus:border-turf focus:bg-rough focus:bg-opacity-20 transition-colors outline-none",placeholder:"Enter player name",autoFocus:!0})]}),a.jsxs("div",{className:"flex space-x-3",children:[a.jsx("button",{onClick:x,className:"flex-1 p-3 bg-rough bg-opacity-30 text-fairway rounded-xl hover:bg-rough hover:bg-opacity-50 font-medium font-primary transition-colors",children:"Cancel"}),a.jsx("button",{onClick:y,disabled:c.trim().length===0,className:De("flex-1 p-3 rounded-xl font-medium font-primary transition-colors",c.trim().length>0?"bg-turf text-scorecard hover:bg-fairway":"bg-soft-grey text-soft-grey cursor-not-allowed"),children:"Save"})]})]})})]})}):null}function ht({competitionId:n,teeTimeId:e,selectedParticipantId:t}){const{data:s,isLoading:c}=Fe(n?parseInt(n):0),{data:h}=Oe((s==null?void 0:s.course_id)||0),{data:y,refetch:x}=$e(n?parseInt(n):0),{data:v,isLoading:l,refetch:g}=Me(n?parseInt(n):0),r=v,{data:f,isLoading:P,refetch:_}=Ve(n?parseInt(n):0),{data:L,refetch:o}=Ge(e?parseInt(e):0),{data:S}=Ke(t||0),I=Ue();return{competition:s,course:h,teeTimes:y,leaderboard:r,teamLeaderboard:f,teeTime:L,selectedParticipant:S,isLoading:c,leaderboardLoading:l,teamLeaderboardLoading:P,refetchTeeTime:o,refetchLeaderboard:g,refetchTeamLeaderboard:_,refetchTeeTimes:x,updateScoreMutation:I}}const G="golf-pending-scores",W=3,j=class j{constructor(){}static getInstance(){return j.instance||(j.instance=new j),j.instance}addPendingScore(e,t,s){const c=this.getPendingScores(),h=`${e}-${t}`;c[h]={participantId:e,hole:t,shots:s,timestamp:Date.now(),attempts:0},this.savePendingScores(c)}removePendingScore(e,t){const s=this.getPendingScores(),c=`${e}-${t}`;delete s[c],this.savePendingScores(s)}getPendingScores(){try{const e=localStorage.getItem(G);return e?JSON.parse(e):{}}catch{return{}}}getPendingScoresArray(){const e=this.getPendingScores();return Object.values(e)}getPendingCount(){return this.getPendingScoresArray().length}markAttempted(e,t){const s=this.getPendingScores(),c=`${e}-${t}`;return s[c]?(s[c].attempts+=1,s[c].attempts>=W&&delete s[c],this.savePendingScores(s),!!s[c]):!1}clearPendingScores(){localStorage.removeItem(G)}getRetryableScores(){return this.getPendingScoresArray().filter(e=>e.attempts<W)}hasConnectivityIssues(){const e=this.getPendingScoresArray(),t=Math.min(...e.map(s=>s.timestamp));return e.length>0&&Date.now()-t>3e4}savePendingScores(e){try{localStorage.setItem(G,JSON.stringify(e))}catch(t){console.error("Failed to save pending scores to localStorage:",t)}}};q(j,"instance");let K=j;const w={TAB_CHANGE:15e3,VISIBILITY_CHANGE:6e4,PERIODIC:3e4,HOLE_NAVIGATION:2e4,INITIAL_FETCH:1e4};class b{static shouldSync(e,t){return Date.now()-e>t}static getSessionKey(e,t){return`golf-sync-${e}-${t}`}static needsInitialSync(e){return!sessionStorage.getItem(e)}static markSyncCompleted(e){sessionStorage.setItem(e,Date.now().toString())}static async handleInitialSync(e){if(!e.teeTimeId||!e.hasData)return!1;const t=this.getSessionKey("initial",e.teeTimeId);return this.needsInitialSync(t)?(console.log("Initial sync for score entry session..."),await e.onSync(),this.markSyncCompleted(t),!0):!1}static async handleTabChangeSync(e){const{newTab:t,teeTimeId:s,lastSyncTime:c}=e;t==="score"&&s&&this.shouldSync(c,w.TAB_CHANGE)&&(console.log("Syncing on tab change to score entry..."),await e.onSync()),(t==="leaderboard"||t==="teams")&&(console.log(`Syncing data for ${t} view...`),e.onLeaderboardSync&&await e.onLeaderboardSync(),t==="teams"&&e.onTeamsSync&&await e.onTeamsSync())}static async handleVisibilityChangeSync(e){return document.hidden||!e.isScoreEntry||!e.teeTimeId?!1:this.shouldSync(e.lastSyncTime,w.VISIBILITY_CHANGE)?(console.log("Syncing after returning to tab..."),await e.onSync(),!0):!1}static shouldSyncOnHoleChange(e,t){return e%3===1&&this.shouldSync(t,w.HOLE_NAVIGATION)}static async handleHoleNavigationSync(e){return e.teeTimeId&&this.shouldSyncOnHoleChange(e.currentHole,e.lastSyncTime)?(console.log(`Syncing on hole navigation to hole ${e.currentHole}...`),await e.onSync(),!0):!1}static needsInitialFetch(e,t){const s=`lastFetch-${e}-${t}`,c=sessionStorage.getItem(s);return(c?Date.now()-parseInt(c):1/0)>w.INITIAL_FETCH}static markInitialFetchCompleted(e,t){const s=`lastFetch-${e}-${t}`;sessionStorage.setItem(s,Date.now().toString())}static async handleInitialViewFetch(e,t,s,c){return this.needsInitialFetch(e,t)?(console.log(`Initial fetch for ${e} view...`),await s(),e==="teams"&&c&&await c(),this.markInitialFetchCompleted(e,t),!0):!1}static createSyncStatus(e,t){const s=e.getPendingCount();return{pendingCount:s,lastSyncTime:t,isOnline:navigator.onLine,hasConnectivityIssues:s>0&&Date.now()-t>w.PERIODIC}}static shouldRunPeriodicSync(e){return e==="leaderboard"||e==="teams"}static async handlePeriodicViewSync(e,t,s){this.shouldRunPeriodicSync(e)&&(console.log(`Periodic sync for ${e} view...`),await t(),e==="teams"&&s&&await s())}static shouldRetryPendingScores(e,t){return e.length>0||this.shouldSync(t,w.PERIODIC)}}function pt({competitionId:n,teeTimeId:e,activeTab:t,refetchTeeTime:s,refetchLeaderboard:c,refetchTeamLeaderboard:h,refetchTeeTimes:y,updateScoreMutation:x,teeTime:v}){const l=K.getInstance(),[g,r]=m.useState(Date.now());m.useEffect(()=>{t==="score"&&e&&v&&b.handleInitialSync({teeTimeId:e,competitionId:n||"",activeTab:t,lastSyncTime:g,hasData:!!v,onSync:async()=>{await s(),r(Date.now())}})},[t,e,v,s,n,g]),m.useEffect(()=>{const o=async()=>{await b.handleVisibilityChangeSync({teeTimeId:e,competitionId:n||"",activeTab:t,lastSyncTime:g,isScoreEntry:t==="score",onSync:async()=>{await s(),r(Date.now())}})&&r(Date.now())};return document.addEventListener("visibilitychange",o),()=>document.removeEventListener("visibilitychange",o)},[t,e,g,s,n]),m.useEffect(()=>{if(!e)return;const o=setInterval(async()=>{try{let S=!1;const I=l.getRetryableScores();if(I.length>0){console.log(`Retrying ${I.length} pending scores...`),S=!0;for(const p of I)try{await x.mutateAsync({participantId:p.participantId,hole:p.hole,shots:p.shots}),l.removePendingScore(p.participantId,p.hole)}catch(k){l.markAttempted(p.participantId,p.hole),console.error(`Retry failed for score ${p.participantId}-${p.hole}:`,k)}}b.shouldRetryPendingScores(I,g)&&(S||b.shouldSync(g,w.PERIODIC))&&(console.log("Syncing with server for latest scores..."),await s(),r(Date.now()))}catch(S){console.error("Sync validation failed:",S)}},w.PERIODIC);return()=>clearInterval(o)},[e,x,s,l,g]),m.useEffect(()=>{if(!n||!b.shouldRunPeriodicSync(t))return;const o=setInterval(async()=>{await b.handlePeriodicViewSync(t,async()=>{await c(),h&&await h()},async()=>{await y()}),r(Date.now())},w.PERIODIC);return()=>clearInterval(o)},[t,n,c,h,y]),m.useEffect(()=>{(t==="leaderboard"||t==="teams")&&n&&b.handleInitialViewFetch(t,n,async()=>{await c(),h&&await h()},async()=>{await y()})},[t,n,c,h,y]);const f=b.createSyncStatus(l,g),P=m.useCallback((o,S,I)=>{const p=parseInt(o);l.addPendingScore(p,S,I),x.mutate({participantId:p,hole:S,shots:I},{onSuccess:()=>{l.removePendingScore(p,S),r(Date.now())},onError:k=>{console.error("Score update failed:",k),l.markAttempted(p,S)}})},[x,l]),_=m.useCallback(async o=>{(o==="leaderboard"||o==="teams")&&(await c(),h&&await h()),(o==="teams"||o==="participants")&&await y(),r(Date.now())},[c,h,y]),L=m.useCallback(async()=>{e&&(await s(),r(Date.now()))},[s,e]);return{syncStatus:f,handleScoreUpdate:P,handleTabChangeSync:_,handleHoleNavigationSync:L}}function yt(n){return n?{id:n.id.toString(),players:n.participants.map(e=>({participantId:e.id.toString(),participantName:e.team_name,participantType:Te(e.position_name),isMultiPlayer:ze(e.position_name),scores:e.score,playerNames:e.player_name,playerId:e.player_id}))}:null}function gt(n){return n?{id:n.id,team_name:n.team_name,position_name:n.position_name,player_name:n.player_name,score:n.score,tee_time_id:n.tee_time_id}:null}function ft(n,e){return n?{id:n.id.toString(),name:e?e.name:`${n.course_name} ${n.teetime}`,holes:n.pars.map((t,s)=>({number:s+1,par:t}))}:null}function It(){var X;const{competitionId:n,teeTimeId:e}=Ye({strict:!1}),t=()=>{if(e)return"score";const i=window.location.hash.replace("#","");return i==="teams"?"teams":i==="participants"?"participants":"leaderboard"},[s,c]=m.useState(t),[h,y]=m.useState(null),[x,v]=m.useState(null),[l,g]=m.useState(()=>{if(e){const i=Q(e),u=sessionStorage.getItem(i);if(u){const N=parseInt(u,10);if(N>=1&&N<=18)return N}}return 1}),{competition:r,course:f,teeTimes:P,leaderboard:_,teamLeaderboard:L,teeTime:o,selectedParticipant:S,isLoading:I,leaderboardLoading:p,teamLeaderboardLoading:k,refetchTeeTime:F,refetchLeaderboard:ee,refetchTeamLeaderboard:te,refetchTeeTimes:U,updateScoreMutation:se}=ht({competitionId:n,teeTimeId:e,selectedParticipantId:h}),{syncStatus:ne,handleScoreUpdate:ae,handleTabChangeSync:re,handleHoleNavigationSync:z}=pt({competitionId:n,teeTimeId:e,activeTab:s,refetchTeeTime:F,refetchLeaderboard:ee,refetchTeamLeaderboard:te,refetchTeeTimes:U,updateScoreMutation:se,teeTime:o});Be((r==null?void 0:r.series_id)||0);const{data:d}=Xe(n?parseInt(n):0),R=m.useMemo(()=>{var A;if(!(d!=null&&d.scoringMode))return;const{scoringMode:i}=d;if(i!=="net"&&i!=="both")return;const u=(A=d.tee)==null?void 0:A.strokeIndex,N=new Map;return d.entries.forEach(C=>{const H=C.participant.id.toString(),D=u&&C.courseHandicap!==void 0?Je(C.courseHandicap,u):void 0;N.set(H,{participantId:H,strokeIndex:u,handicapStrokesPerHole:D,courseHandicap:C.courseHandicap,handicapIndex:C.participant.handicap_index})}),N},[d]),oe=Ze(),ie=qe(),[ce,O]=m.useState(!1),[le,$]=m.useState(!1);m.useEffect(()=>{e&&l&&Qe(e,l)},[e,l]),m.useEffect(()=>{if(o!=null&&o.participants&&o.participants.length>0)if(o.participants.filter(u=>Array.isArray(u.score)).length===o.participants.length){const u=We(o.participants);O(u)}else O(!1);else O(!1)},[o]),m.useEffect(()=>{if(!o)return;const i=e?Q(e):null,u=i?sessionStorage.getItem(i):null,N=Array.isArray(o.participants)?o.participants:[],A=N.length===0||N.every(D=>{const J=Array.isArray(D.score)?D.score:[];return J.length===0||J.every(Z=>!Z||Z===0)}),C=typeof o.start_hole=="number"?o.start_hole:void 0,H=C===1||C===10;if(A&&H){g(C),i&&sessionStorage.setItem(i,String(C));return}!u&&H&&(g(C),i&&sessionStorage.setItem(i,String(C)))},[o,e]);const M=yt(o),E=ft(o,f),de=gt(S||null),ue=o&&f?{id:f.id.toString(),name:f.name,holes:o.pars.map((i,u)=>({number:u+1,par:i}))}:null,me=async i=>{c(i),await re(i)},T=i=>{y(i)},he=()=>{y(null)},pe=()=>{console.log("Round completed!")},ye=(i,u,N)=>{v({id:i,currentName:u,positionName:N})},ge=()=>{v(null)},fe=(i,u)=>{oe.mutate({id:parseInt(i),data:{player_names:u}},{onSuccess:()=>{F(),v(null)}})},V=m.useCallback(async i=>{g(i),await z()},[z]),Se=L||[],Y=et(P),B=E==null?void 0:E.holes.find(i=>i.number===l),xe=()=>{$(!0)},Ce=()=>{o!=null&&o.participants&&(o.participants.forEach(i=>{ie.mutate(i.id)}),$(!1))},ve=((X=o==null?void 0:o.participants)==null?void 0:X.some(i=>i.is_locked))||!1;if(I)return a.jsx("div",{className:"p-4",children:"Loading competition..."});if(!r)return a.jsx("div",{className:"p-4",children:"Competition not found"});const Ie=()=>{switch(s){case"score":return!M||!E?a.jsx(St,{teeTimes:P||[],competitionId:n||""}):a.jsx("div",{className:"h-full flex flex-col",children:a.jsx("div",{className:"flex-1 overflow-hidden",children:a.jsx(ot,{teeTimeGroup:M,course:E,onScoreUpdate:ae,onComplete:pe,currentHole:l,onHoleChange:V,syncStatus:ne,onPlayerNameClick:ye,isReadyToFinalize:ce,onFinalize:xe,isLocked:ve,competition:{id:r.id,series_id:r.series_id,series_name:r.series_name,tour_id:r.tour_id},isTourCompetition:!!r.tour_id,netScoringData:R})})});case"leaderboard":const i=r!=null&&r.tour_id?d==null?void 0:d.entries:_;return a.jsx(dt,{leaderboard:i,leaderboardLoading:p,onParticipantClick:T,isRoundView:!0,isTourCompetition:!!(r!=null&&r.tour_id),scoringMode:d==null?void 0:d.scoringMode,teeInfo:d==null?void 0:d.tee,categoryTees:d==null?void 0:d.categoryTees,categories:d==null?void 0:d.categories});case"teams":return a.jsx(lt,{teamResults:Se,leaderboardLoading:k,individualResults:_,isRoundView:!0,onParticipantClick:T});case"participants":return a.jsx(ct,{teeTimes:P,teeTimesLoading:!1,competitionId:n||"",venueType:r==null?void 0:r.venue_type,currentTeeTimeId:e,currentTeeTime:o,showCurrentGroup:!0,totalParticipants:Y,isTourCompetition:!!(r!=null&&r.tour_id),isOpenStart:(r==null?void 0:r.start_mode)==="open",onGroupUpdated:()=>{F(),U()}});default:return null}};return a.jsxs(tt,{title:r.name,subtitle:f==null?void 0:f.name,seriesId:r.series_id,seriesName:r.series_name,className:"h-screen flex flex-col",children:[a.jsx("div",{className:"flex-1 overflow-hidden",children:Ie()}),s==="score"&&B&&a.jsx(st,{currentHole:l,holePar:B.par,holeHcp:(()=>{var i;if(R&&R.size>0){const u=R.values().next().value;return(i=u==null?void 0:u.strokeIndex)==null?void 0:i[l-1]}})(),onPrevious:()=>V(Math.max(1,l-1)),onNext:()=>V(Math.min(18,l+1)),canGoPrevious:l>1,canGoNext:l<18,className:"flex-shrink-0"}),a.jsx(nt,{activeTab:s,onTabChange:me,className:"flex-shrink-0",hiddenTabs:r!=null&&r.tour_id?["teams"]:[],participantsLabel:r!=null&&r.tour_id?"Groups":void 0}),a.jsx(ut,{competition:r,courseName:f==null?void 0:f.name,totalParticipants:Y,variant:"footer"}),a.jsx(at,{visible:h!==null,participant:de,course:ue,onClose:he}),a.jsx(mt,{isOpen:x!==null,onClose:ge,onSave:fe,participant:x}),a.jsx(rt,{visible:le,teeTimeGroup:M||{id:"",players:[]},course:E||{id:"",name:"",holes:[]},currentHole:l,onClose:()=>$(!1),onLockRound:Ce,netScoringData:R})]})}function St({teeTimes:n,competitionId:e}){const t=it();return a.jsx("div",{className:"flex flex-col items-center justify-center h-full p-6 text-center",children:a.jsxs("div",{className:"max-w-md",children:[a.jsx("h2",{className:"text-xl font-bold text-charcoal mb-4",children:"No Valid Tee Time"}),a.jsx("p",{className:"text-turf mb-6",children:"You don't have access to score entry for this competition. You can view the leaderboard or participant list instead."}),a.jsxs("div",{className:"space-y-3",children:[a.jsx("button",{onClick:()=>t({to:`/player/competitions/${e}`}),className:"w-full bg-coral text-scorecard px-4 py-2 rounded-lg font-medium hover:bg-coral/90 transition-colors",children:"View Competition Details"}),n&&n.length>0&&a.jsxs("div",{className:"text-sm text-turf",children:[a.jsx("p",{className:"mb-2",children:"Available tee times:"}),a.jsxs("div",{className:"space-y-1",children:[n.slice(0,3).map(s=>a.jsxs("div",{className:"text-xs",children:[s.teetime," - ",s.participants.length," players"]},s.id)),n.length>3&&a.jsxs("div",{className:"text-xs",children:["... and ",n.length-3," more"]})]})]})]})]})})}export{It as default};
